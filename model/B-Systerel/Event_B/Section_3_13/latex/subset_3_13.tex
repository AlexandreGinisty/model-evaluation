\documentclass{template/openetcs_article}
% Use the option "nocc" if the document is not licensed under Creative Commons
%\documentclass[nocc]{template/openetcs_article}
\usepackage {bsymb,b2latex}
\usepackage{lipsum,url,color}
\graphicspath{{./template/}{.}{./images/}}
\begin{document}
\frontmatter
\project{openETCS}

%Please do not change anything above this line
%============================
% The document metadata is defined below

%assign a report number here
\reportnum{OETCS}

%define your workpackage here
\wp{Work-Package 7: ``Toolchain''}


\newcommand{\true}{\ensuremath{true}}
\newcommand{\btext}[1]{{\it #1}}
\newcommand{\bvar}[1]{\btext{#1}}
\newcommand{\bevent}[1]{\btext{#1}}
\newcommand{\binv}[1]{\btext{#1}}
\newcommand{\bconst}[1]{\btext{#1}}
\newcommand{\bparam}[1]{\btext{#1}}
\newcommand{\bfunc}[1]{\btext{#1}}
\newcommand{\baxiom}[1]{\btext{#1}}
\newcommand{\btype}[1]{\btext{#1}}
\newcommand{\bguard}[1]{\btext{#1}}
\newcommand{\bmachine}[1]{\btext{#1}}
\newcommand{\bctx}[1]{\btext{#1}}

\author{Matthias Güdemann}

\affiliation{Systerel\\
  Les Portes de l’Arbois, Bâtiment A \\
  1090 rue René Descartes \\
  13857 Aix-en-Provence Cedex 3, France
}

\title{Event-B Model of Subset 026, Section 3.13}

% define the coverart
\coverart[width=350pt]{openETCS_EUPL}

\reporttype{Model Description}

%\begin{document}

\maketitle
\tableofcontents
\listoffiguresandtables
\newpage

This document describes a formal model of the requirements of section~3.13 of
the subset 026 of the ETCS specification 3.3.0~\cite{SRS-026-330}. This section
describes the speed and distance monitoring subsystem of ETCS.

The model is expressed in the formal language Event-B~\cite{abrial-eventB-Book}
and developed within the Rodin tool~\cite{rodin-handbook}. This formalism allows
an iterative modeling approach. In general, one starts with a very abstract
description of the basic functionality and step-wise adds additional details
until the desired level of accuracy of the model is reached. Rodin provides the
necessary proof support to ensure the correctness of the refined behavior.

In this document we present an Event-B model of the speed and distance
monitoring subsystem of ETCS. At first, we describe shortly the background of
Event-B, then the overall approach taken to model this section and finally
present the model in detail.

The section~3.13 of the SRS gives a very detailed description of the calculation
of many necessary values for speed and distance monitoring. As Event-B is a
system modeling approach, we give an abstract model of the system. The
calculations are abstracted as functions and the system ensures the correct
parameter flow to the functions. We illustrate the model decomposition
capabilities of Event-B and Rodin by decomposing the overall model into
different functional parts.

For a short introduction on Event-B and the usage of Rodin with models on github
see~\url{https://github.com/openETCS/model-evaluation/blob/master/model/B-Systerel/Event_B/rodin-projects-github.pdf?raw=true}

% \begin{table}[ht]
%   \centering
%   \begin{tabular}[ht]{|l|l|}
%     \hline
%      &  \\
%     \hline
%   \end{tabular}
%   \caption{Glossary}
%   \label{tab:glossary}
% \end{table}

\section{Modeling Strategy}
\label{sec:modeling-strategy}

The section~3.13 of the SRS describes the speed and distance monitoring together
with the necessary parameters and data. The model starts with an abstract
modeling of dataflow of the various intermediate calculated values. This model
is partitioned into functional parts, the model is decomposed using shared
variables and the respective sub-models are refined until the basic calculation
functions are reached.

\section{Model Overview}
\label{sec:model-overview}

The overview of the speed and distance monitoring is shown in
Fig.~\ref{fig:speed-distance-system} from the SRS.

\begin{figure}[ht]
  \centering
  \includegraphics[width=.9\textwidth]{Overview_13_3}
  \caption{Speed and Distance Monitoring Overview~(\cite{SRS-026-330}~p.~85)}
  \label{fig:speed-distance-system}
\end{figure}

The on-board system comprises only the middle layer. The upper layer gives train
related inputs as parameters, the lower layer track related inputs. The system
itself takes the current position, speed and acceleration of the train and
computes commands for the train interface and for the driver machine
interface. For the train interface, this consists of the command for the service
and emergency brakes. For the driver machine interface this consists of the
status indication for the driver.

The Event-B modeling starts with machines describing the dataflow of all inputs,
outputs and intermediate values of the model. For example, the values that are
calculated for \bvar{T\_brake\_service} in \bmachine{Traction / Braking Models}
are written into a variable by an event that calculates then and these values
and are read as input by the event that calculates \bvar{T\_bs} for \bvar{SBI}
limit.

This approach is conducted for each intermediate value of the system until a
single machine is created with one variable for each intermediate value as well
as for each input and output. On this level of modeling, all events only define
the necessary input values and write a new value to their output variable. This
value is provided as event parameter on this abstraction level.

The next step is to decompose the single machine into different sub-machines, in
general one machine for each functional part of the model. This allows for model
structuring and complexity reduction for each machine. For this we use the Rodin
decomposition
plug-in~\footnote{\url{http://wiki.event-b.org/index.php/Decomposition_Plug-in_User_Guide}}
using the shared-variable decomposition
approach~\cite{silva2011decomposition}. This approach splits the set of events
of a machine into several disjoint sets and assigns one such set to each
sub-machine. It also allows to distribute the variables over several machines,
effectively implementing a shared variable distributed system.

The borders for the subsystem decomposition are shown in
Fig.~\ref{fig:system-decomposition}. The dashed lines show the separate
sub-machines. The dataflows that cross these lines are represented by the shared
variables of the decomposed model.

\begin{figure}[ht]
  \centering
  \includegraphics[width=.66\textwidth]{OverviewSelected}
  \caption{Decomposition of System}
  \label{fig:system-decomposition}
\end{figure}

Each of the sub-machines with its shared variables is then further refined until
the desired level of detail is reached. The overview of these refinements is
shown in Fig.~\ref{fig:machine-decompositon-overview}.

\begin{figure}[ht]
  \centering
  \includegraphics[width=\textwidth]{Section_3_13-layout}
  \caption{Machine Decomposition Overview}
  \label{fig:machine-decompositon-overview}
\end{figure}

This refinement and context overview is very different from the others, as first
an abstract global model was developed and then this model was decomposed into
sub-models which are further refined. The contexts are shared between the
decomposed models as far as possible. In this case, all resulting contexts and
machines are kept in the same Rodin project. It is also possible to create
a new project for each sub-machine which will reduce the complexity of each
single project.

The global model is shown in the lower right. The first machine describes the
global input and output variables of the system. The further refinements
represent the iterative addition of more functions as shown in
Fig.~\ref{fig:system-decomposition}. For example the machine 1 adds the brake
model with its inputs and outputs and the machine 2 adds the calculation of
deceleration which uses the outputs of the braking model.

The last machine is then decomposed into the nine machines representing each a
single functional block. This structure is shown in the upper part of
Fig.~\ref{fig:machine-decompositon-overview}, this also illustrates the further
independent refinement of the decomposed sub-machine.

The context hierarchy also reflects this structuring. The contexts define the
data types for the intermediate values, as well as the functions that calculate
these values. These functions are generally not further refined in the Event-B
model, as this is not part of the system modeling.

\section{Model Benefits}
\label{sec:model-highlights}

The modeled section of the SRS provides many details for calculation of various
values. The main content from a system modeling point of view is the model. So
while in this case the same benefits from using Rodin as
for~\cite{Section-3-5-Rodin,Section-4-6-Rodin,Section-5-9-Rodin} are present,
the main advantage here is the model structuring facility.

\begin{itemize}
\item {\bf Model Decomposition} The shared variable model
  decomposition~\cite{silva2011decomposition} allows for decomposing an Event-B
  model and for separate refining of the machines of the resulting
  sub-models while retaining correctness of the refinement proofs.
\end{itemize}

\section{Detailed Model Description}
\label{sec:deta-model-descr}


\subsection{Context 0 - Train Inputs, TI and DMI command}
\label{sec:context-0-entities}

The first context introduces many basic type for the model,
\btype{t\_locations}, \btype{t\_speed}, \btype{t\_acceleration},
\btype{t\_TI\_commands}, \btype{t\_DMI\_commands}, \btype{t\_time} and
\btype{t\_train\_modes}.

The commands for the train interface (TI) are represented by the constants
\bconst{c\_emergency\_brake}, \bconst{c\_service\_brake}, \bconst{c\_TCO},
\bconst{c\_no\_command}. For the driver machine interface (DMI) the commands are
represented by the constants \bconst{c\_normal}, \bconst{c\_indication},
\bconst{c\_overspeed}, \bconst{c\_warning} and \bconst{c\_intervention}.

The other constants provide default values for the initialization of variables
of that type.

{\footnotesize
\input{c0_train_ti_dmi_commands}
}

\subsection{Machine 0 - Train Status and Commands}
\label{sec:machine-0-train}

This first machine introduces the external input variables, i.e., the position,
speed and acceleration of the train as well as the output variables, i.e., the
TI commands and the DMI commands. The input variables are read by the event
\bevent{update\_train\_style} and the output variables by the event
\bevent{new\_outputs}.

{\footnotesize
\input{m0_trainstatus_commands}
}

\subsection{Machine 1 - Brake Model}
\label{sec:machine-1-brake}

The first refinement adds the notion of the brake model. This is represented by
the variables describing the speed dependent acceleration functions for
emergency, service and normal service braking. The variables
\bvar{T\_brake\_service} and \bvar{T\_brake\_emergency} describe the brake
build-up times for the brakes.

{\footnotesize
\input{m1_brake_model}
}

\subsection{Context 1 - Decelerations}
\label{sec:cont-1-decel}

This context extension adds a distance type and a function that maps the speed
and distance to an acceleration.

{\footnotesize
\input{c1_decelerations}
}

\subsection{Machine 2 - Calculate Decelerations}
\label{sec:machine-2-calculate}

This refinement adds the calculation of deceleration to the model. This is
represented by three variables which are functions that map speed and distance
to an acceleration. There is one function for each on of EBD, SBD and GUI.

{\footnotesize
\input{m2_calculation_deceleration}
}

\subsection{Machine 3 - Calculation of Brake Buildup Time}
\label{sec:mach-3-calc}

The next machine refinement adds the brake buildup calculation to the
model. This is represented by two variables, \bvar{T\_be} for the emergency
brake and \bvar{T\_se} for the service brake.

{\footnotesize
\input{m3_safe_brake_buildup}
}

\subsection{Machine 4 - Acceleration due to Gradient}
\label{sec:mach-4-accel}

The refinement adds the notion of the acceleration due to gradient. This is
represented by the variable \bvar{A\_gradient} which is a function that maps
speed to acceleration.

{\footnotesize
\input{m4_accel_decel_gradient}
}

\subsection{Context 3 - Speed Profiles}
\label{sec:context-3-speed}

This context extension introduces the type \btype{speed\_profiles} which maps
locations to speeds. It also defines one constant value of that type which is
used as default value for variables of that type.

{\footnotesize
\input{c3_speed_profiles}
}

\subsection{Machine 5 - Most Restrictive Speed Profile}
\label{sec:machine-5-most}

This machine refinement introduces the most restrictive speed profile to the
model. This is represented by the variable \bvar{MRSP} of the type
\btype{speed\_profile}.

{\footnotesize
\input{m5_MRSP}
}

\subsection{Context 4 - Targets}
\label{sec:context-4-targets}

This context extension introduces the type \btype{t\_targets} which represents a
target, i.e., a pair of location and speed.

{\footnotesize
\input{c4_targets}
}

\subsection{Machine 6 - Supervised Targets}
\label{sec:machine-6-supervised}

This refinement adds limit of authority, end of authority and supervision limit
to the model. For each there exists one variable of type \btype{t\_targets}.

{\footnotesize
\input{m6_supervised_targets}
}

\subsection{Context 5 - Braking Curves}
\label{sec:context-5-braking}

This context extension introduces the type \btype{t\_braking\_curves} and a
constant of that type.

{\footnotesize
\input{c5_braking_curves}

\subsection{Machine 7 - Braking Curves}
\label{sec:machine-7-braking}

This machine refinement adds the braking curves to the model, these are
represented by the three variables \bvar{EBD}, \bvar{SBD} and \bvar{GUI} of the
appropriate type.

{\footnotesize
\input{m7_braking_curves}
}

\subsection{Context 6 - Supervision Limits}
\label{sec:cont-6-superv}

This context adds the type \btype{t\_supervision\_limits} to the model, as well
as a constant value of that type.

{\footnotesize
\input{c6_supervision_limits}
}

\subsection{Machine 8 - Supervision Limit}
\label{sec:mach-8-superv}

This machine refinement adds the supervision limits to the model, emergency
brake intervention (\bvar{EBI}), service brake intervention (\bvar{SBI}),
warning limit (\bvar{warning\_limit}), permitted speed (\bvar{P\_limit}),
indication limit (\bvar{I\_limit}), pre-indication location (\bvar{PI\_limit})
and the release start speed monitoring location (\bvar{RSM\_start}).

{\footnotesize
\input{m8_supervision_limits}
}

\section{Model Decomposition}
\label{sec:model-decomposition}

The machine m9 does not really add detail to the refined machine m8. The only
changes are that the variables which are read by an event are explicitly added
to the conditions by specifying a typing condition for them. This assures that
the model decomposition preserves these necessary variables in the sub-machines
and only removes the unneeded ones.

\bibliographystyle{alpha}
\bibliography{openetcs}

\end{document}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
